<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Creating fat JARs with gradle</title> 
    <meta name="description" content="Example snippets to package JVM application into single fat JAR with gradle">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,400i,700,700i&display=swap" />
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="canonical" href="https://romanmarkunas.github.io/build/2018/11/13/0007-build-gradle-fat-jars/">
    <link rel="alternate" type="application/rss+xml" title="Roman Markunas (Romans Markuns) blog Feed" href="https://romanmarkunas.github.io/feed.xml">
</head>
<body onload="transformSyntaxHiglightsBecausePygmentsJavaLexerIsRubbish();">
    <div class="site">
        <nav id="top" class="site-nav outer" aria-label="Main Menu">
    <div class="inner">
        <div class="site-nav-inside">

            <button id="menu-show" class="js-menu-toggle"><span class="icon icon-menu"
                    aria-hidden="true"></span>Menu</button>

            <div class="menu-panel">
                <div class="menu-panel-scrollable">
                    <div class="menu-panel-top">
                        <button id="menu-hide" class="js-menu-toggle button button-icon button-fill-horz"><span class="icon icon-close" aria-hidden="true"></span><span class="screen-reader-text">Close</span></button>
                    </div>
                    <ul class="menu">
                        
                        
                        
                        <li class="menu-item ">
                            <a href="/">Home</a>
                        </li>
                        
                        
                        
                        <li class="menu-item ">
                            <a href="/tags/">Archive</a>
                        </li>
                        
                    </ul>
                </div>
            </div><!-- .menu-panel -->

            <ul class="actions">
                <li>
                    <a class="button button-icon button-fill-horz"
                       href="https://www.linkedin.com/in/romansmarkuns"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg><span class="screen-reader-text">LinkedIn</span></a>
                </li>
                <li>
                    <a class="button button-icon button-fill-horz"
                       href="https://github.com/romanmarkunas"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg><span class="screen-reader-text">GitHub</span></a>
                </li>
                <li>
                    <a class="button button-icon button-fill-horz"
                        href="/feed.xml"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19.199 24C19.199 13.467 10.533 4.8 0 4.8V0c13.165 0 24 10.835 24 24h-4.801zM3.291 17.415c1.814 0 3.293 1.479 3.293 3.295 0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526 0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727 0 15.909 7.184 15.909 15.91z"/></svg><span class="screen-reader-text">Subscribe</span></a>
                </li>
            </ul><!-- .actions -->

        </div><!-- .site-nav-inside -->
    </div><!-- .inner -->
</nav><!-- .site-nav -->

        <header class="site-alto-header outer">
    <div class="inner">
        <div class="site-header-inside">

<!--            -->

        </div><!-- .site-header-inside -->
    </div><!-- .inner -->
</header><!-- .site-header -->

        <div class="site-content outer">
            <div class="inner">
                <main class="site-main">
                    <div class="primary">
    <article class="post post-full">
        <header class="post-header">
            <div class="post-header-wrap">
                <h1 class="post-title outer">Creating fat JARs with gradle</h1>
            </div>
        </header><!-- .post-header -->
        <div class="post-content inner-small outer">
            <time class="published" datetime="">2018-11-13</time><span class="reading-time" title="Estimated read time">
  
  
    	&mdash; 3 min read
  
</span>


            <br>

            
            
            <a href="/tags/index.html#build" rel="tag" id="a-post-tag">#build</a>
            
            <a href="/tags/index.html#gradle" rel="tag" id="a-post-tag">#gradle</a>
            
            <a href="/tags/index.html#java" rel="tag" id="a-post-tag">#java</a>
            
            <br>
            
            <br>

            <p>Here’s a quick tutorial on how to package your java application and dependencies into single fat JAR (shadow JAR, capsule, however it’s called) with gradle.</p>

<!--more-->

<h2>Easy solution using built-in JAR gradle plugin</h2>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">jar</span> <span class="o">{</span>
   <span class="n">from</span> <span class="o">{</span><span class="n">configurations</span><span class="o">.</span><span class="na">compile</span><span class="o">.</span><span class="na">collect</span> <span class="o">{</span> <span class="n">it</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">()</span> <span class="o">?</span> <span class="n">it</span> <span class="o">:</span> <span class="n">zipTree</span><span class="o">(</span><span class="n">it</span><span class="o">)</span> <span class="o">}</span> <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>What it means:</p>
<ul>
  <li><em>jar</em> - packaging task available in gradle as part of <em>java</em> plugin</li>
  <li><em>from</em> - copies passed FileTree into JAR</li>
  <li><em>configurations</em> - holds all configurations (set of dependencies)</li>
  <li><em>compile</em> - I used compile configuration for this particular example, but this could be any other or even a separate configuration just for fat JAR</li>
  <li><em>zipTree</em> - this returns zipped file tree object, because JAR files essentially are ZIP files with specific file arrangement and content</li>
</ul>

<p>While this is nice one-liner that uses only built-in gradle stuff, it will work only in cases when there are no name clashes in all dependencies. For example, if more than one dependency implements Java SPI service interface you will have multiple resources with the same name and only last one will make it into fat JAR.</p>

<h2>Using Shadow JAR plugin</h2>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">buildscript</span> <span class="o">{</span>
    <span class="n">dependencies</span> <span class="o">{</span>
        <span class="n">classpath</span> <span class="s1">'com.github.jengelman.gradle.plugins:shadow:4.0.1'</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">'com.github.johnrengelman.shadow'</span>

<span class="n">shadowJar</span> <span class="o">{</span>
    <span class="n">mergeServiceFiles</span><span class="o">()</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Internally this plugin does the same thing as previous one-liner, plus:</p>
<ul>
  <li>It collates SPI service files</li>
  <li>inherits configuration from <em>jar</em> task so that you may define manifest in standard familiar way:</li>
</ul>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">jar</span> <span class="o">{</span>
    <span class="n">manifest</span> <span class="o">{</span>
        <span class="n">attributes</span><span class="o">(</span>
            <span class="s1">'Main-Class'</span><span class="o">:</span> <span class="s2">"com.example.CraneBookingApplication"</span>
        <span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2>Using Shadow JAR plugin with Windows</h2>

<p>There is important caveat for Windows users however with previous method. Shadow JAR uses <em>\n</em> as line separator when merging SPI files. Consequently, when JAR is run on Windows JVM will not be able to correctly read file line-by-line. To avoid this, we define custom service file transformer in <em>build.gradle</em> that will use <em>\r\n</em> as line separator:</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.github.jengelman.gradle.plugins.shadow.relocation.Relocator</span>
<span class="kn">import</span> <span class="nn">com.github.jengelman.gradle.plugins.shadow.transformers.ServiceFileTransformer</span>

<span class="kd">class</span> <span class="nc">WindowsTransformer</span> <span class="kd">extends</span> <span class="n">ServiceFileTransformer</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kt">void</span> <span class="nf">transform</span><span class="o">(</span><span class="n">String</span> <span class="n">path</span><span class="o">,</span> <span class="n">InputStream</span> <span class="n">is</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Relocator</span><span class="o">&gt;</span> <span class="n">relocators</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">is</span><span class="o">.</span><span class="na">readLines</span><span class="o">()</span>
        
        <span class="n">relocators</span><span class="o">.</span><span class="na">each</span> <span class="o">{</span><span class="n">rel</span> <span class="o">-&gt;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">rel</span><span class="o">.</span><span class="na">canRelocateClass</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">path</span><span class="o">).</span><span class="na">name</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="na">relocateClass</span><span class="o">(</span><span class="n">path</span><span class="o">)</span>
            <span class="o">}</span>
            <span class="n">lines</span><span class="o">.</span><span class="na">eachWithIndex</span> <span class="o">{</span> <span class="n">String</span> <span class="n">line</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">-&gt;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">rel</span><span class="o">.</span><span class="na">canRelocateClass</span><span class="o">(</span><span class="n">line</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">lines</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="na">relocateClass</span><span class="o">(</span><span class="n">line</span><span class="o">)</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        
        <span class="n">lines</span><span class="o">.</span><span class="na">each</span> <span class="o">{</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="n">serviceEntries</span><span class="o">[</span><span class="n">path</span><span class="o">]</span>
                <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="k">new</span> <span class="n">ByteArrayInputStream</span><span class="o">((</span><span class="n">line</span> <span class="o">+</span> <span class="s2">"\r\n"</span><span class="o">).</span><span class="na">getBytes</span><span class="o">()))</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">shadowJar</span> <span class="o">{</span>
<span class="c1">//    mergeServiceFiles() - should not be used, as it uses default transformer</span>
    <span class="n">transform</span><span class="o">(</span><span class="n">WindowsTransformer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>
        </div><!-- .post-content -->
        <footer class="post-footer inner-small outer">
            <div class="post-share">
                <span>Share:</span>
                <a class="button button-icon button-fill-horz"
                    href="https://twitter.com/intent/tweet?text=Creating%20fat%20JARs%20with%20gradle&amp;url=https://romanmarkunas.github.io/build/2018/11/13/0007-build-gradle-fat-jars/"
                    target="_blank" rel="noopener"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M23.954 4.569a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.691 8.094 4.066 6.13 1.64 3.161a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.061a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.937 4.937 0 004.604 3.417 9.868 9.868 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63a9.936 9.936 0 002.46-2.548l-.047-.02z"/></svg><span
                        class="screen-reader-text">Share on Twitter</span></a>
                <a class="button button-icon button-fill-horz"
                    href="https://www.facebook.com/sharer/sharer.php?u=https://romanmarkunas.github.io/build/2018/11/13/0007-build-gradle-fat-jars/&amp;t=Creating%20fat%20JARs%20with%20gradle"
                    target="_blank" rel="noopener"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M23.998 12c0-6.628-5.372-12-11.999-12C5.372 0 0 5.372 0 12c0 5.988 4.388 10.952 10.124 11.852v-8.384H7.078v-3.469h3.046V9.356c0-3.008 1.792-4.669 4.532-4.669 1.313 0 2.686.234 2.686.234v2.953H15.83c-1.49 0-1.955.925-1.955 1.874V12h3.328l-.532 3.469h-2.796v8.384c5.736-.9 10.124-5.864 10.124-11.853z"/></svg><span
                        class="screen-reader-text">Share on Facebook</span></a>
            </div>
<!--            -->
<!--            <div class="post-tags">-->
<!--                <span>Tags:</span>-->
<!--                <a href="/tags/index.html#build" rel="tag">build</a><a href="/tags/index.html#gradle" rel="tag">gradle</a><a href="/tags/index.html#java" rel="tag">java</a>-->
<!--            </div>-->
<!--            -->
        </footer><!-- .post-footer -->
    </article><!-- .post -->
    <nav class="post-navigation">
        <h2 class="screen-reader-text">Read Next</h2>
        
        <div class="nav-previous">
            <div class="nav-inside inner-small outer">
                
                <div class="nav-before">Previous</div>
                <h3 class="nav-title"><a href="/messaging/2018/10/01/0006-messaging-kafka-in-practice-1-producer/">Kafka transactions in practice 1: Producer</a>
                </h3>
                <div class="nav-date">October 1, 2018</div>
            </div><!-- .nav-inside -->
        </div><!-- .nav-previous -->
        
        
        <div class="nav-next">
            <div class="nav-inside inner-small outer">
                
                <div class="nav-before">Next</div>
                <h3 class="nav-title"><a href="/microservices/2018/11/15/0008-microservices-dropwizard-101/">Getting started with Dropwizard</a></h3>
                <div class="nav-date">November 15, 2018</div>
            </div><!-- .nav-inside -->
        </div><!-- .nav-next -->
        
    </nav><!-- .post-navigation -->

    <div class="comments-area">
        <div class="inner-small outer">
<!--            <h2 class="comments-title line-accent">Comments</h2>-->
            <div id="hyvor-talk-view"></div>
            <script type="text/javascript">
                var HYVOR_TALK_WEBSITE = 708; // DO NOT CHANGE THIS
                var HYVOR_TALK_CONFIG = {
                    url: 'https://romanmarkunas.github.io/build/2018/11/13/0007-build-gradle-fat-jars/',
                    id: '/build/2018/11/13/--0007---build---gradle-fat-jars'
                };
            </script>
            <script async type="text/javascript" src="//talk.hyvor.com/web-api/embed"></script>

        </div><!-- .inner-small -->
    </div><!-- .comments-area -->

</div><!-- .primary -->

<aside class="sidebar">

    <section class="widget widget-text">
        <h2 class="widget-title line-accent">About</h2>
        <p style="text-align:justify;">
            I am Roma, a Java developer focusing on high-throughput
            systems. This blog is a collection of tech, performance and
            design tips, broadly covering my experience out in the field.
        </p>
    </section><!-- .widget-text -->

    

    

    <section class="widget widget-recent-posts">
        <h2 class="widget-title line-accent">Latest Posts</h2>
        <ul class="recent-posts">
            
            <li class="recent-item"><a href="/microservices/2018/11/15/0008-microservices-dropwizard-101/">Getting started with Dropwizard</a> <span>November 15, 2018</span></li>
            
            <li class="recent-item"><a href="/build/2018/11/13/0007-build-gradle-fat-jars/">Creating fat JARs with gradle</a> <span>November 13, 2018</span></li>
            
            <li class="recent-item"><a href="/messaging/2018/10/01/0006-messaging-kafka-in-practice-1-producer/">Kafka transactions in practice 1: Producer</a> <span>October 1, 2018</span></li>
            
            <li class="recent-item"><a href="/core-java/2018/10/01/0005-core-java-random/">Notes on Java Random</a> <span>October 1, 2018</span></li>
            
            <li class="recent-item"><a href="/uncategorized/2018/10/01/0004-uncategorized-monty-hall/">Monty-Hall problem</a> <span>October 1, 2018</span></li>
            
        </ul><!-- .recent-posts -->
    </section><!-- .widget-recent-posts -->

    <!--Create a sorted array of tags-->
    
    
    <section class="widget widget-tags">
        <h2 class="widget-title line-accent">Tags</h2>
        <div class="tagcloud">
            <a href="/tags/#build">build</a><a href="/tags/#concurrency">concurrency</a><a href="/tags/#core+java">core java</a><a href="/tags/#coroutines">coroutines</a><a href="/tags/#dropwizard">dropwizard</a><a href="/tags/#gradle">gradle</a><a href="/tags/#java">java</a><a href="/tags/#kafka">kafka</a><a href="/tags/#low+latency">low latency</a><a href="/tags/#messaging">messaging</a><a href="/tags/#microservices">microservices</a><a href="/tags/#multithreading">multithreading</a><a href="/tags/#non-blocking+IO">non-blocking IO</a><a href="/tags/#quasar">quasar</a>
        </div><!-- .tagcloud -->
    </section><!-- .widget -->

</aside><!-- .sidebar -->


                </main><!-- .site-main -->
            </div><!-- .inner -->
        </div><!-- .site-content -->
        <footer class="site-footer outer">
    <div class="inner">
        <div class="site-info">
            <a href="#top" id="js-top-link" class="top-link button button-icon button-fill-horz"><span class="screen-reader-text">Back to the top</span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3.44 18.359l8.56-8.541 8.56 8.541 2.63-2.63-11.189-11.189-11.189 11.189z"></path></svg></a>
        </div><!-- .site-info -->
    </div><!-- .inner -->
</footer><!-- .site-footer -->

    </div><!-- .site -->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-117056147-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-117056147-2');
</script>

    
    <script src="/js/scripts.js"></script>
</body>
</html>
