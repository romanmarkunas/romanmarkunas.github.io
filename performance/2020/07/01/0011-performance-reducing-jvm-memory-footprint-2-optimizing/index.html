<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Reducing JVM heap size, part 2: Optimizing</title> 
    <meta name="description" content="Step by step guide on how to reduce JVM memory footprint. Part 2: Reducing memory consumption/footprint.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,400i,700,700i&display=swap" />
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="canonical" href="https://romanmarkunas.com/performance/2020/07/01/0011-performance-reducing-jvm-memory-footprint-2-optimizing/">
    <link rel="alternate" type="application/rss+xml" title="Roman Markunas (Romans Markuns) blog Feed" href="https://romanmarkunas.com/feed.xml">
    
    <script data-ad-client="ca-pub-9488600968816185" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    
</head>
<body onload="transformSyntaxHiglightsBecausePygmentsJavaLexerIsRubbish();">
    <div class="site">
        <nav id="top" class="site-nav outer" aria-label="Main Menu">
    <div class="inner">
        <div class="site-nav-inside">

            <button id="menu-show" class="js-menu-toggle"><span class="icon icon-menu"
                    aria-hidden="true"></span>Menu</button>

            <div class="menu-panel">
                <div class="menu-panel-scrollable">
                    <div class="menu-panel-top">
                        <button id="menu-hide" class="js-menu-toggle button button-icon button-fill-horz"><span class="icon icon-close" aria-hidden="true"></span><span class="screen-reader-text">Close</span></button>
                    </div>
                    <ul class="menu">
                        
                        
                        
                        <li class="menu-item ">
                            <a href="/">Home</a>
                        </li>
                        
                        
                        
                        <li class="menu-item ">
                            <a href="/tags/">Archive</a>
                        </li>
                        
                    </ul>
                </div>
            </div><!-- .menu-panel -->

            <ul class="actions">
                <li>
                    <a class="button button-icon button-fill-horz"
                       href="https://www.linkedin.com/in/romansmarkuns"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg><span class="screen-reader-text">LinkedIn</span></a>
                </li>
                <li>
                    <a class="button button-icon button-fill-horz"
                       href="https://github.com/romanmarkunas"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg><span class="screen-reader-text">GitHub</span></a>
                </li>
                <li>
                    <a class="button button-icon button-fill-horz"
                        href="/feed.xml"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19.199 24C19.199 13.467 10.533 4.8 0 4.8V0c13.165 0 24 10.835 24 24h-4.801zM3.291 17.415c1.814 0 3.293 1.479 3.293 3.295 0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526 0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727 0 15.909 7.184 15.909 15.91z"/></svg><span class="screen-reader-text">Subscribe</span></a>
                </li>
            </ul><!-- .actions -->

        </div><!-- .site-nav-inside -->
    </div><!-- .inner -->
</nav><!-- .site-nav -->

        <header class="site-alto-header outer">
    <div class="inner">
        <div class="site-header-inside">

<!--            -->

        </div><!-- .site-header-inside -->
    </div><!-- .inner -->
</header><!-- .site-header -->

        <div class="site-content outer">
            <div class="inner">
                <main class="site-main">
                    <div class="primary">
    <article class="post post-full">
        <header class="post-header">
            <div class="post-header-wrap">
                <h1 class="post-title outer">Reducing JVM heap size, part 2: Optimizing</h1>
            </div>
        </header><!-- .post-header -->
        <div class="post-content inner-small outer">
            <time class="published" datetime="">2020-07-01</time><span class="reading-time" title="Estimated read time">
  
  
    	&mdash; 11 min read
  
</span>


            <br>

            
            
            <a href="/tags/index.html#performance" rel="tag" id="a-post-tag">#performance</a>
            
            <a href="/tags/index.html#java" rel="tag" id="a-post-tag">#java</a>
            
            <a href="/tags/index.html#memory" rel="tag" id="a-post-tag">#memory</a>
            
            <br>
            
            <br>

            <p>In this article we will look at different ways to figure out and fix unnecessary memory consumption by JVM. This is useful for JVM applications that store huge amount of data in memory and can help avoid OutOfMemoryError if application data cannot be partitioned and scaled horizontally.</p>

<p>In part 2, we will take a look on couple of techniques used to reduce JVM heap size. <!--more--> The techniques listed in the order of least invasive to most, so that optimization does just enough for application to work and keeps it as maintainable as possible. The example application can be found in <a href="/performance/2020/07/01/0010-performance-reducing-jvm-memory-footprint-1-profile/">part 1</a> or in <a href="https://github.com/romanmarkunas-com/0010-memory-optimization">example source code</a>.</p>

<h2>Memory optimisation - data structures</h2>

<p>As mentioned before we could fit around 204500 orders/54600 users into 64M heap. Let’s take a look on how we can improve this.</p>

<p>The least intrusive change is usually changing data structures that hold objects. These usually conform to some of Java collection interfaces and changing them would not introduce much change in the code. Let’s see how much memory we can save by doing so.</p>

<p>First obvious candidate would be <code class="highlighter-rouge">ArrayList</code> as it’s no arg constructor would create a list which will have capacity of 10 after first insertion. However we have around 200K orders across 50K users, which brings the average number of orders per list to 4. We can be aggressive and set that size to 1 initially. That gives us 209000 orders/54900 users. Easy win, but only 2%.</p>

<p>Second optimization has to do with java <code class="highlighter-rouge">HashMap</code>, which uses simple chaining implementation. That is memory efficient only if map key collision rate is low. In our case both order and user ids is about 18% (<a href="https://github.com/romanmarkunas-com/0010-memory-optimization/blob/master/src/test/java/com/romanmarkunas/blog/memory/example1/HashCollisionTest.java">see this test</a>), so there might be potential here. Maps that use open addressing implementation remain memory efficient even with high collision rates. Any open addressing implementation should do, as collision resolution strategy (probing, Robin-Hood, cuckoo, etc) should not significantly impact memory footprint.</p>

<p>I’ll use Agrona <code class="highlighter-rouge">Object2ObjectHashMap</code> to test this. Agrona’s implementation also does not create extra <code class="highlighter-rouge">Node</code> objects, as it stores keys and values as even and odd indexes in the same array. Changing map implementation (<a href="https://github.com/romanmarkunas-com/0010-memory-optimization/blob/3550717a4e365a87f4000c6ea703a2c4f3d847d1/src/test/java/com/romanmarkunas/blog/memory/OrderStoreMainTest.java#L141">example 8</a>) gives us 231500 orders/56000 users, which is significant 11% increase.</p>

<h2>Memory optimisation - using minimal types to store data</h2>

<p>Let’s take a look at <code class="highlighter-rouge">Order</code> objects themselves.</p>

<p>First step is to look at the structure of stored values. We want them to have as flat structure as possible, minimizing extra object header overhead. In our case we would just get rid of a boxed type. This brings us to 245900 orders/56600 users, which is another 6%. Quite significant increase for this little work.</p>

<p>Now when the low hanging fruit was plucked, we should take a look at out value type and evaluate if we represent data with appropriate types.</p>

<p>In or case, we have another field which is secretly boxed, which is <code class="highlighter-rouge">Order#id</code>. At the moment, this field is just a number, but wrapped as <code class="highlighter-rouge">String</code>. Most times there is no need for id field to be a string, as we can represent enough unique identifiers with a simple number (or a tuple of numbers) and have a <code class="highlighter-rouge">Long</code> keys in a map:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">user</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">articleNr</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">price</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">address</span><span class="o">;</span>

    <span class="c1">// rest of class omitted for clarity</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">Order</span><span class="o">&gt;</span> <span class="n">ordersById</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object2ObjectHashMap</span><span class="o">&lt;&gt;();</span>
</code></pre></div></div>

<p>By doing so we can fit 276100 order/57900 users, that’s another 12% up. However, we are now forced to waste some memory for autoboxing <code class="highlighter-rouge">long</code>, which we can fix by using primitive collection. There are ready libraries to do this, for example Trove collections. Here I’ll use Agrona, since I’ve already used it in example before:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Long2ObjectHashMap</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="n">ordersById</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Long2ObjectHashMap</span><span class="o">&lt;&gt;();</span>
</code></pre></div></div>

<p>That’s 288300 orders/58300 users, which is extra 4%, and the final code can be observed in <a href="https://github.com/romanmarkunas-com/0010-memory-optimization/blob/3550717a4e365a87f4000c6ea703a2c4f3d847d1/src/test/java/com/romanmarkunas/blog/memory/OrderStoreMainTest.java#L151">example 9</a>.</p>

<h2>Memory optimisation - shared object pool</h2>

<p>At this point most of memory would be occupied by address <code class="highlighter-rouge">String</code>. The problem here is that addresses contain lots of repeating information: cities, post codes, street numbers, names and surnames, etc. What we can try to do, is to break address apart into these components and share repeating instances between <code class="highlighter-rouge">Order</code> values. JVM even has built in <code class="highlighter-rouge">String</code> pool for us to use!</p>

<p>I’ve decided to break up address like this:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">user</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">articleNr</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">pricePence</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">addressNumber</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">addressStreet</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">addressCity</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">addressRegion</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">addressPostCode</span><span class="o">;</span>

    <span class="c1">// rest of class omitted for clarity</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Without pooling we can only fit 144200 orders/50000 users into memory, which again proves that object header overhead is very significant. It might seem like a step back, but let’s turn <code class="highlighter-rouge">String</code> pooling on in <code class="highlighter-rouge">Order</code> constructor (<a href="https://github.com/romanmarkunas-com/0010-memory-optimization/blob/3550717a4e365a87f4000c6ea703a2c4f3d847d1/src/test/java/com/romanmarkunas/blog/memory/OrderStoreMainTest.java#L161">example 10</a>):</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@JsonCreator</span>
<span class="kd">public</span> <span class="nf">Order</span><span class="o">(</span>
        <span class="c1">// some fields omitted</span>
        <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"addressNumber"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">addressNumber</span><span class="o">,</span>
        <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"addressStreet"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">addressStreet</span><span class="o">,</span>
        <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"addressCity"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">addressCity</span><span class="o">,</span>
        <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"addressRegion"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">addressRegion</span><span class="o">,</span>
        <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"addressPostCode"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">addressPostCode</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// some fields omitted</span>
    <span class="k">this</span><span class="o">.</span><span class="na">addressNumber</span> <span class="o">=</span> <span class="n">addressNumber</span><span class="o">.</span><span class="na">intern</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">addressStreet</span> <span class="o">=</span> <span class="n">addressStreet</span><span class="o">.</span><span class="na">intern</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">addressCity</span> <span class="o">=</span> <span class="n">addressCity</span><span class="o">.</span><span class="na">intern</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">addressRegion</span> <span class="o">=</span> <span class="n">addressRegion</span><span class="o">.</span><span class="na">intern</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">addressPostCode</span> <span class="o">=</span> <span class="n">addressPostCode</span><span class="o">.</span><span class="na">intern</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>which let’s us fit 386000 orders/61000 users into memory (+34%)! JVM since version 7 does not allocate interned <code class="highlighter-rouge">String</code> objects in native memory, therefore this gain is fair comparison (this can be double checked by running JVM with flags <code class="highlighter-rouge">-XX:+UnlockDiagnosticVMOptions -XX:NativeMemoryTracking=summary -XX:+PrintNMTStatistics</code> and inspecting memory usage).</p>

<p>As far as I know, <code class="highlighter-rouge">String</code> pool is the only JVM pool which is usable by application, because <code class="highlighter-rouge">Integer</code> pool goes only up to 128. However, it shouldn’t be hard to pool any user defined object. Usability of this method depends on how much of data is repeating and how it could be split and the object overhead of internal pool implementation (e.g. be careful with tree-like collections which allocate extra object for every node).</p>

<h2>Memory optimisation - data encoding</h2>

<p>Compression approach can save some memory at the expense of processing power and code maintainability as switching form JDK types to custom ones limits the usage of library methods.</p>

<p>Since we only use capital letters and digits for ids, we can encode strings using base 36 encoding. Base 36 values would take only 6 bits each, instead of usual 8 bits (16 bits before Java 9) per character, therefore it is expected to save about 25% of memory (60% before Java9):</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">Order</span><span class="o">(</span>
            <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="kt">long</span> <span class="n">id</span><span class="o">,</span>
            <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"user"</span><span class="o">)</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">user</span><span class="o">,</span>
            <span class="c1">// rest omitted</span>
</code></pre></div></div>

<p>and we only need to store reference to string as a map key:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ordersByUser</span>
        <span class="o">.</span><span class="na">computeIfAbsent</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">Base36String</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getUser</span><span class="o">()),</span> 
                <span class="n">key</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="mi">1</span><span class="o">)</span>
        <span class="o">)</span>
        <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
</code></pre></div></div>

<p>More compact encoding (<a href="https://github.com/romanmarkunas-com/0010-memory-optimization/blob/3550717a4e365a87f4000c6ea703a2c4f3d847d1/src/test/java/com/romanmarkunas/blog/memory/OrderStoreMainTest.java#L175">example 11</a>) and not storing extra reference on <code class="highlighter-rouge">Order</code> objects allows us to stuff JVM with 481300 orders/62800 users (+24%).</p>

<h2>Memory optimisation - ditching references</h2>

<p>Now we can try to get rid of extra <code class="highlighter-rouge">String</code> object references and store only <code class="highlighter-rouge">byte[]</code>. If we ever need a <code class="highlighter-rouge">String</code> object later in code we can allocate short-lived object for that operation or use a view wrapper. This is somewhat risky, because arrays in Java are not immutable, but let’s see how much memory we can save that way.</p>

<p>Simple type replacement, however, would not work here as our strings are pooled objects. Therefore, we need to roll out our own pool for <code class="highlighter-rouge">byte[]</code>. This is a bit tricky in Java, cause Java arrays do not properly implement <code class="highlighter-rouge">hashCode</code> or <code class="highlighter-rouge">equals</code>, but we can leverage array order and <code class="highlighter-rouge">TreeSet</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TreeBasedByteArrayPool</span> <span class="kd">implements</span> <span class="nc">ByteArrayPool</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">NavigableSet</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">values</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TreeSet</span><span class="o">&lt;&gt;(</span><span class="nl">Arrays:</span><span class="o">:</span><span class="n">compare</span><span class="o">);</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">intern</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">in</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">newValue</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">newValue</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">in</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">values</span><span class="o">.</span><span class="na">floor</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>and inject pool during deserialization like so:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@JsonCreator</span>
<span class="kd">public</span> <span class="nf">Order</span><span class="o">(</span>
        <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="kt">long</span> <span class="n">id</span><span class="o">,</span>
        <span class="c1">// more fields here ...</span>
        <span class="nd">@JacksonInject</span> <span class="nc">ByteArrayPool</span> <span class="n">byteArrayPool</span>
<span class="o">)</span>
</code></pre></div></div>

<p>This approach (<a href="https://github.com/romanmarkunas-com/0010-memory-optimization/blob/3550717a4e365a87f4000c6ea703a2c4f3d847d1/src/test/java/com/romanmarkunas/blog/memory/OrderStoreMainTest.java#L186">example 12</a>) doesn’t help us much, because by getting rid of some references in <code class="highlighter-rouge">Order</code> object, we’ve created many more references within <code class="highlighter-rouge">TreeSet</code>, and thus for this use-case we can actually fit less objects in memory. Even linear-time array-based implementation does not reduce memory footprint much, which means, that for our data structure this optimization is not useful.</p>

<h2>Memory optimisation - object compression</h2>

<p>Now what if we could compress the whole <code class="highlighter-rouge">Order</code> object? In our case we must only compress fields which are not shared between <code class="highlighter-rouge">Order</code> instances (non-address fields are <code class="highlighter-rouge">transient</code>), hence we end up with something like this (<a href="https://github.com/romanmarkunas-com/0010-memory-optimization/blob/3550717a4e365a87f4000c6ea703a2c4f3d847d1/src/test/java/com/romanmarkunas/blog/memory/OrderStoreMainTest.java#L197">example 13</a>):</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderCompressed</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">compressedPart</span><span class="o">;</span>
    <span class="c1">// shared fields omitted</span>
    <span class="c1">// constructor omitted</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">OrderCompressed</span> <span class="nf">compress</span><span class="o">(</span><span class="nc">Order</span> <span class="n">order</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ByteArrayOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">(</span>
                <span class="nc">GZIPOutputStream</span> <span class="n">gzipOut</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GZIPOutputStream</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
                <span class="nc">ObjectOutputStream</span> <span class="n">objectOut</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectOutputStream</span><span class="o">(</span><span class="n">gzipOut</span><span class="o">);</span>
        <span class="o">)</span> <span class="o">{</span>
            <span class="n">objectOut</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Unable to serialize "</span> <span class="o">+</span> <span class="n">order</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">OrderCompressed</span><span class="o">(</span>
                <span class="n">bytes</span><span class="o">,</span>
                <span class="n">order</span><span class="o">.</span><span class="na">getAddressNumber</span><span class="o">(),</span>
                <span class="n">order</span><span class="o">.</span><span class="na">getAddressStreet</span><span class="o">(),</span>
                <span class="n">order</span><span class="o">.</span><span class="na">getAddressCity</span><span class="o">(),</span>
                <span class="n">order</span><span class="o">.</span><span class="na">getAddressRegion</span><span class="o">(),</span>
                <span class="n">order</span><span class="o">.</span><span class="na">getAddressPostCode</span><span class="o">()</span>
        <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>In our case this also does not give any memory reduction, as we are only compressing couple of primitive fields. This technique is much more useful where it is impossible to share much data between retained objects.</p>

<h2>Conclusion</h2>

<p>Using appropriate data structures, variable types, compression and pooling we have reduced memory consumption by 135% (fitting 481300 orders instead of 204500). More memory usage reduction can be achieved by bulk compressing larger chunks of data together or moving off-heap. These however impact code and architecture quite a bit and must be considered along with data sharding approaches.</p>
        </div><!-- .post-content -->
        <footer class="post-footer inner-small outer">
            <div class="post-share">
                <span>Share:</span>
                <a class="button button-icon button-fill-horz"
                    href="https://twitter.com/intent/tweet?text=Reducing%20JVM%20heap%20size,%20part%202:%20Optimizing&amp;url=https://romanmarkunas.com/performance/2020/07/01/0011-performance-reducing-jvm-memory-footprint-2-optimizing/"
                    target="_blank" rel="noopener"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M23.954 4.569a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.691 8.094 4.066 6.13 1.64 3.161a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.061a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.937 4.937 0 004.604 3.417 9.868 9.868 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63a9.936 9.936 0 002.46-2.548l-.047-.02z"/></svg><span
                        class="screen-reader-text">Share on Twitter</span></a>
                <a class="button button-icon button-fill-horz"
                    href="https://www.facebook.com/sharer/sharer.php?u=https://romanmarkunas.com/performance/2020/07/01/0011-performance-reducing-jvm-memory-footprint-2-optimizing/&amp;t=Reducing%20JVM%20heap%20size,%20part%202:%20Optimizing"
                    target="_blank" rel="noopener"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M23.998 12c0-6.628-5.372-12-11.999-12C5.372 0 0 5.372 0 12c0 5.988 4.388 10.952 10.124 11.852v-8.384H7.078v-3.469h3.046V9.356c0-3.008 1.792-4.669 4.532-4.669 1.313 0 2.686.234 2.686.234v2.953H15.83c-1.49 0-1.955.925-1.955 1.874V12h3.328l-.532 3.469h-2.796v8.384c5.736-.9 10.124-5.864 10.124-11.853z"/></svg><span
                        class="screen-reader-text">Share on Facebook</span></a>
            </div>
<!--            -->
<!--            <div class="post-tags">-->
<!--                <span>Tags:</span>-->
<!--                <a href="/tags/index.html#performance" rel="tag">performance</a><a href="/tags/index.html#java" rel="tag">java</a><a href="/tags/index.html#memory" rel="tag">memory</a>-->
<!--            </div>-->
<!--            -->
        </footer><!-- .post-footer -->
    </article><!-- .post -->
    <nav class="post-navigation">
        <h2 class="screen-reader-text">Read Next</h2>
        
        <div class="nav-previous">
            <div class="nav-inside inner-small outer">
                
                <div class="nav-before">Previous</div>
                <h3 class="nav-title"><a href="/performance/2020/07/01/0010-performance-reducing-jvm-memory-footprint-1-profile/">Reducing JVM heap size, part 1: Profiling</a>
                </h3>
                <div class="nav-date">July 1, 2020</div>
            </div><!-- .nav-inside -->
        </div><!-- .nav-previous -->
        
        
    </nav><!-- .post-navigation -->

    <div class="comments-area">
        <div class="inner-small outer">
<!--            <h2 class="comments-title line-accent">Comments</h2>-->
            <div id="hyvor-talk-view"></div>
            <script type="text/javascript">
                var HYVOR_TALK_WEBSITE = 708; // DO NOT CHANGE THIS
                var HYVOR_TALK_CONFIG = {
                    url: 'https://romanmarkunas.com/performance/2020/07/01/0011-performance-reducing-jvm-memory-footprint-2-optimizing/',
                    id: '/performance/2020/07/01/--0011---performance---reducing-jvm-memory-footprint-2-optimizing'
                };
            </script>
            <script async type="text/javascript" src="//talk.hyvor.com/web-api/embed"></script>

        </div><!-- .inner-small -->
    </div><!-- .comments-area -->

</div><!-- .primary -->

<aside class="sidebar">

    <section class="widget widget-text">
        <h2 class="widget-title line-accent">About</h2>
        <p style="text-align:justify;">
            I am Roma, a Java developer focusing on high-throughput
            systems. This blog is a collection of tech, performance and
            design tips, broadly covering my experience out in the field.
        </p>
    </section><!-- .widget-text -->

    

    

    <section class="widget widget-recent-posts">
        <h2 class="widget-title line-accent">Latest Posts</h2>
        <ul class="recent-posts">
            
            <li class="recent-item"><a href="/performance/2020/07/01/0011-performance-reducing-jvm-memory-footprint-2-optimizing/">Reducing JVM heap size, part 2: Optimizing</a> <span>July 1, 2020</span></li>
            
            <li class="recent-item"><a href="/performance/2020/07/01/0010-performance-reducing-jvm-memory-footprint-1-profile/">Reducing JVM heap size, part 1: Profiling</a> <span>July 1, 2020</span></li>
            
            <li class="recent-item"><a href="/protocols/2020/06/03/0009-protocols-jackson-mixins/">Jackson mix-ins</a> <span>June 3, 2020</span></li>
            
            <li class="recent-item"><a href="/microservices/2018/11/15/0008-microservices-dropwizard-101/">Getting started with Dropwizard</a> <span>November 15, 2018</span></li>
            
            <li class="recent-item"><a href="/build/2018/11/13/0007-build-gradle-fat-jars/">Creating fat JARs with gradle</a> <span>November 13, 2018</span></li>
            
        </ul><!-- .recent-posts -->
    </section><!-- .widget-recent-posts -->

    <!--Create a sorted array of tags-->
    
    
    <section class="widget widget-tags">
        <h2 class="widget-title line-accent">Tags</h2>
        <div class="tagcloud">
            <a href="/tags/#build">build</a><a href="/tags/#concurrency">concurrency</a><a href="/tags/#core+java">core java</a><a href="/tags/#coroutines">coroutines</a><a href="/tags/#design">design</a><a href="/tags/#dropwizard">dropwizard</a><a href="/tags/#gradle">gradle</a><a href="/tags/#jackson">jackson</a><a href="/tags/#java">java</a><a href="/tags/#kafka">kafka</a><a href="/tags/#low+latency">low latency</a><a href="/tags/#memory">memory</a><a href="/tags/#messaging">messaging</a><a href="/tags/#microservices">microservices</a><a href="/tags/#multithreading">multithreading</a><a href="/tags/#non-blocking+IO">non-blocking IO</a><a href="/tags/#performance">performance</a><a href="/tags/#protocols">protocols</a><a href="/tags/#quasar">quasar</a>
        </div><!-- .tagcloud -->
    </section><!-- .widget -->

</aside><!-- .sidebar -->


                </main><!-- .site-main -->
            </div><!-- .inner -->
        </div><!-- .site-content -->
        <footer class="site-footer outer">
    <div class="inner">
        <div class="site-info">
            <a href="#top" id="js-top-link" class="top-link button button-icon button-fill-horz"><span class="screen-reader-text">Back to the top</span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3.44 18.359l8.56-8.541 8.56 8.541 2.63-2.63-11.189-11.189-11.189 11.189z"></path></svg></a>
        </div><!-- .site-info -->
    </div><!-- .inner -->
</footer><!-- .site-footer -->

    </div><!-- .site -->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-117056147-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-117056147-2');
</script>

    
    <script src="/js/scripts.js"></script>
</body>
</html>
